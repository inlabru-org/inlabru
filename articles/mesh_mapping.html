<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="inlabru">
<title>Converting inla.spde.make.A calls into the bru_mapper system • inlabru</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Converting inla.spde.make.A calls into the bru_mapper system">
<meta property="og:description" content="inlabru">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">inlabru</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.9.0.9005</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Basic examples</h6>
    <a class="dropdown-item" href="../articles/random_fields.html">Random field models in 1D</a>
    <a class="dropdown-item" href="../articles/random_fields_2d.html">Spatial random field models in 2D</a>
    <a class="dropdown-item" href="../articles/publications.html">Publications</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Point process examples</h6>
    <a class="dropdown-item" href="../articles/1d_lgcp.html">LGCPs - An example in one dimension</a>
    <a class="dropdown-item" href="../articles/2d_lgcp.html">LGCPs - An example in two dimensions (sp version)</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_sf.html">LGCPs - An example in two dimensions (sf version)</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_covars.html">LGCPs - Spatial covariates</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_distancesampling.html">LGCPs - Distance sampling</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_plotsampling.html">LGCPs - Plot sampling</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_multilikelihood.html">LGCPs - Multiple likelihoods</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_spatiotemporal.html">LGCPs - An example in space and time</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_residuals.html">LGCPs - Residuals</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Concepts</h6>
    <a class="dropdown-item" href="../articles/component.html">Defining a model component</a>
    <a class="dropdown-item" href="../articles/svc.html">Spatially varying coefficient models</a>
    <a class="dropdown-item" href="../articles/prediction_scores.html">Computing posterior prediction scores</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Theory and technical documentation</h6>
    <a class="dropdown-item" href="../articles/Apptainer.html">Installation of INLA and inlabru with Apptainer on HPC</a>
    <a class="dropdown-item" href="../articles/method.html">The iterative linearised inlabru method</a>
    <a class="dropdown-item" href="../articles/linearapprox.html">A nonlinear model approximation example</a>
    <a class="dropdown-item" href="../articles/bru_mapper.html">Customised model component with the bru_mapper system</a>
    <a class="dropdown-item" href="../articles/mesh_mapping.html">Converting inla.spde.make.A calls to the bru_mapper system</a>
    <a class="dropdown-item" href="../articles/devel_flow.html">Code internal flow diagrams for model evaluation</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/website_examples.html">Website articles</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/inlabru-org/inlabru/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Converting inla.spde.make.A calls into the bru_mapper system</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/inlabru-org/inlabru/blob/HEAD/vignettes/articles/mesh_mapping.Rmd" class="external-link"><code>vignettes/articles/mesh_mapping.Rmd</code></a></small>
      <div class="d-none name"><code>mesh_mapping.Rmd</code></div>
    </div>

    
    
<p>(Vignette under construction!)</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In traditional <code>INLA</code> code involving
<code>inla.mesh</code> objects and <code>inla.spde</code> models, the
<code><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A()</a></code> function is used to construct the
component design matrix that maps between spatial/spatio-temporal
locations and the latent variables associated with mesh basis functions.
For 2-manifold meshes, such as flat and spherical meshes, the
implementation has one latent variable per mesh node, linked to
piecewise linear basis functions on the mesh triangles. For 1-manifolds
such as intervals and cyclic domains, both piecewise linear and
piecewise quadratic basis functions are supported.</p>
<p>The <code><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A()</a></code> interface supports a variety of
features, that can be broken down in more simple building blocks. With
the <code>inlabru</code> <code>bru_mapper</code> system, these building
blocks are more easily customised for specific uses, some of which
aren’t necessarily connected to spde models, such as the
<code>block</code> feature that is used to aggregate rows of a design
matrix, e.g. to construct numerical integration schemes.</p>
<p>If you haven’t already, go read the <a href="http://inlabru-org.github.io/inlabru/articles/bru_mapper.html" class="external-link">bru_mapper</a>
vignette for information about the various <code>bru_mapper</code>
classes and methods. Then come back here to continue.</p>
</div>
<div class="section level2">
<h2 id="converting-the-basic-inla-spde-make-a-calls-into-mappers">Converting the basic inla.spde.make.A calls into mappers<a class="anchor" aria-label="anchor" href="#converting-the-basic-inla-spde-make-a-calls-into-mappers"></a>
</h2>
<p>The most basic <code>inla.spde.make.A</code> call is to map purely
spatial points to a mesh:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d_inla</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, offset <span class="op">=</span> <span class="fl">2</span>, max.edge <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/gg.html">gg</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">loc</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">loc</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="mesh_mapping_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A.loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A</a></span><span class="op">(</span><span class="va">mesh</span>, loc <span class="op">=</span> <span class="va">loc</span><span class="op">)</span></span>
<span><span class="va">A.loc</span></span>
<span><span class="co">#&gt; 5 x 9 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">#&gt;                                                                          </span></span>
<span><span class="co">#&gt; [1,] . 0.29227293 0.09984048 .         .          .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [2,] . 0.02324195 0.36614606 .         .          .         . . 0.6106120</span></span>
<span><span class="co">#&gt; [3,] . .          0.11935641 0.1416259 .          .         . . 0.7390177</span></span>
<span><span class="co">#&gt; [4,] . .          .          0.3522410 0.08180227 .         . . 0.5659568</span></span>
<span><span class="co">#&gt; [5,] . .          .          .         0.19233634 0.2974006 . . 0.5102631</span></span></code></pre></div>
<p>A basic conversion of this becomes</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A.loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_basis.html" class="external-link">fm_basis</a></span><span class="op">(</span><span class="va">mesh</span>, loc <span class="op">=</span> <span class="va">loc</span><span class="op">)</span></span>
<span><span class="va">A.loc</span></span>
<span><span class="co">#&gt; 5 x 9 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">#&gt;                                                                          </span></span>
<span><span class="co">#&gt; [1,] . 0.29227293 0.09984048 .         .          .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [2,] . 0.02324195 0.36614606 .         .          .         . . 0.6106120</span></span>
<span><span class="co">#&gt; [3,] . .          0.11935641 0.1416259 .          .         . . 0.7390177</span></span>
<span><span class="co">#&gt; [4,] . .          .          0.3522410 0.08180227 .         . . 0.5659568</span></span>
<span><span class="co">#&gt; [5,] . .          .          .         0.19233634 0.2974006 . . 0.5102631</span></span></code></pre></div>
<p>but this is limited to just the basic case of evaluating on only a
mesh.</p>
<p>With a <code>bru_mapper</code>, this becomes the more generally
useful</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span>
<span><span class="va">A.loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_jacobian</a></span><span class="op">(</span><span class="va">mapper</span>, input <span class="op">=</span> <span class="va">loc</span><span class="op">)</span></span>
<span><span class="va">A.loc</span></span>
<span><span class="co">#&gt; 5 x 9 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">#&gt;                                                                          </span></span>
<span><span class="co">#&gt; [1,] . 0.29227293 0.09984048 .         .          .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [2,] . 0.02324195 0.36614606 .         .          .         . . 0.6106120</span></span>
<span><span class="co">#&gt; [3,] . .          0.11935641 0.1416259 .          .         . . 0.7390177</span></span>
<span><span class="co">#&gt; [4,] . .          .          0.3522410 0.08180227 .         . . 0.5659568</span></span>
<span><span class="co">#&gt; [5,] . .          .          .         0.19233634 0.2974006 . . 0.5102631</span></span></code></pre></div>
<div class="section level3">
<h3 id="mapping-with-a-precomputed-location-mapping">Mapping with a precomputed location mapping<a class="anchor" aria-label="anchor" href="#mapping-with-a-precomputed-location-mapping"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A</a></span><span class="op">(</span>A.loc <span class="op">=</span> <span class="va">A.loc</span>, index <span class="op">=</span> <span class="va">index</span><span class="op">)</span></span>
<span><span class="co">#&gt; 6 x 9 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">#&gt;                                                                         </span></span>
<span><span class="co">#&gt; [1,] . 0.29227293 0.09984048 .         .         .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [2,] . .          0.11935641 0.1416259 .         .         . . 0.7390177</span></span>
<span><span class="co">#&gt; [3,] . .          .          .         0.1923363 0.2974006 . . 0.5102631</span></span>
<span><span class="co">#&gt; [4,] . 0.02324195 0.36614606 .         .         .         . . 0.6106120</span></span>
<span><span class="co">#&gt; [5,] . 0.29227293 0.09984048 .         .         .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [6,] . 0.02324195 0.36614606 .         .         .         . . 0.6106120</span></span>
<span></span>
<span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_taylor</a></span><span class="op">(</span>jacobian <span class="op">=</span> <span class="va">A.loc</span><span class="op">[</span><span class="va">index</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_jacobian</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span><span class="co">#&gt; 6 x 9 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">#&gt;                                                                         </span></span>
<span><span class="co">#&gt; [1,] . 0.29227293 0.09984048 .         .         .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [2,] . .          0.11935641 0.1416259 .         .         . . 0.7390177</span></span>
<span><span class="co">#&gt; [3,] . .          .          .         0.1923363 0.2974006 . . 0.5102631</span></span>
<span><span class="co">#&gt; [4,] . 0.02324195 0.36614606 .         .         .         . . 0.6106120</span></span>
<span><span class="co">#&gt; [5,] . 0.29227293 0.09984048 .         .         .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [6,] . 0.02324195 0.36614606 .         .         .         . . 0.6106120</span></span>
<span></span>
<span><span class="co"># For run-time indexing:</span></span>
<span><span class="va">mapper</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_pipe</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      matrix <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_taylor</a></span><span class="op">(</span>jacobian <span class="op">=</span> <span class="va">A.loc</span><span class="op">)</span>,</span>
<span>      index <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_index</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">A.loc</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_jacobian</a></span><span class="op">(</span><span class="va">mapper</span>, input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 6 x 9 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">#&gt;                                                                         </span></span>
<span><span class="co">#&gt; [1,] . 0.29227293 0.09984048 .         .         .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [2,] . .          0.11935641 0.1416259 .         .         . . 0.7390177</span></span>
<span><span class="co">#&gt; [3,] . .          .          .         0.1923363 0.2974006 . . 0.5102631</span></span>
<span><span class="co">#&gt; [4,] . 0.02324195 0.36614606 .         .         .         . . 0.6106120</span></span>
<span><span class="co">#&gt; [5,] . 0.29227293 0.09984048 .         .         .         . . 0.6078866</span></span>
<span><span class="co">#&gt; [6,] . 0.02324195 0.36614606 .         .         .         . . 0.6106120</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="group-mapping-with-a-group-mesh">Group mapping with a group mesh<a class="anchor" aria-label="anchor" href="#group-mapping-with-a-group-mesh"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A</a></span><span class="op">(</span><span class="va">...</span>, group <span class="op">=</span> <span class="va">group.values</span>, group.mesh <span class="op">=</span> <span class="va">group.mesh</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_multi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  main <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">group.mesh</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_jacobian</a></span><span class="op">(</span><span class="va">mapper</span>, input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">loc</span>, group <span class="op">=</span> <span class="va">group.values</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="blockwise-aggregation">Blockwise aggregation<a class="anchor" aria-label="anchor" href="#blockwise-aggregation"></a>
</h3>
<p>Blockwise aggregation can be implemented with a
<code>bru_mapper_aggregate</code> mapper.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block_rescale</span> <span class="op">&lt;-</span> <span class="st">"none"</span> <span class="co"># one of "none", "count", "weights", "sum"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A</a></span><span class="op">(</span><span class="va">...</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>  block <span class="op">=</span> <span class="va">block</span>,</span>
<span>  block.rescale <span class="op">=</span> <span class="va">block_rescale</span>,</span>
<span>  n.block <span class="op">=</span> <span class="va">n_block</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Rescaling options:</p>
<ul>
<li>
<code>block_rescale = "none"</code> corresponds to
<code>rescale = FALSE</code>
</li>
<li>
<code>block_rescale = "count"</code> corresponds to
<code>rescale = TRUE</code> and providing no <code>weights</code>, as
that is interpreted as all weights being <code>1</code>, so rescaling by
the sum of the weights is equivalent to dividing by the number of
elements in each block.</li>
<li>
<code>block_rescale = "weights"</code> corresponds to
<code>rescale = TRUE</code>
</li>
<li>
<code>block_rescale = "sum"</code> is not supported by the
aggregation mapper.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_pipe</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    main <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_multi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>main <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    block <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_aggregate</a></span><span class="op">(</span></span>
<span>      rescale <span class="op">=</span> <span class="op">(</span><span class="va">block_rescale</span> <span class="op">!=</span> <span class="st">"none"</span><span class="op">)</span>,</span>
<span>      n_block <span class="op">=</span> <span class="va">n_block</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_jacobian</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">loc</span><span class="op">)</span>,</span>
<span>    block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>block <span class="op">=</span> <span class="va">block</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inla-spde-make-index">inla.spde.make.index<a class="anchor" aria-label="anchor" href="#inla-spde-make-index"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ngroup</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">nrepl</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.index.html" class="external-link">inla.spde.make.index</a></span><span class="op">(</span><span class="st">"field"</span>,</span>
<span>      n.spde <span class="op">=</span> <span class="va">mesh</span><span class="op">$</span><span class="va">n</span>,</span>
<span>      n.group <span class="op">=</span> <span class="va">ngroup</span>,</span>
<span>      n.repl <span class="op">=</span> <span class="va">nrepl</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;      field    field.group    field.repl</span></span>
<span><span class="co">#&gt;  Min.   :1   Min.   :1.0   Min.   :1   </span></span>
<span><span class="co">#&gt;  1st Qu.:3   1st Qu.:1.0   1st Qu.:1   </span></span>
<span><span class="co">#&gt;  Median :5   Median :1.5   Median :2   </span></span>
<span><span class="co">#&gt;  Mean   :5   Mean   :1.5   Mean   :2   </span></span>
<span><span class="co">#&gt;  3rd Qu.:7   3rd Qu.:2.0   3rd Qu.:3   </span></span>
<span><span class="co">#&gt;  Max.   :9   Max.   :2.0   Max.   :3</span></span>
<span></span>
<span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_multi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  field.main <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span>,</span>
<span>  field.group <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_index</a></span><span class="op">(</span><span class="va">ngroup</span><span class="op">)</span>,</span>
<span>  field.replicate <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_index</a></span><span class="op">(</span><span class="va">nrepl</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    field.main  field.group  field.replicate</span></span>
<span><span class="co">#&gt;  Min.   :1    Min.   :1.0   Min.   :1      </span></span>
<span><span class="co">#&gt;  1st Qu.:3    1st Qu.:1.0   1st Qu.:1      </span></span>
<span><span class="co">#&gt;  Median :5    Median :1.5   Median :2      </span></span>
<span><span class="co">#&gt;  Mean   :5    Mean   :1.5   Mean   :2      </span></span>
<span><span class="co">#&gt;  3rd Qu.:7    3rd Qu.:2.0   3rd Qu.:3      </span></span>
<span><span class="co">#&gt;  Max.   :9    Max.   :2.0   Max.   :3</span></span></code></pre></div>
<p>The benefit of the mapper approach here is that it encapsulates all
the information, so that only the mapper needs to be carried around to
code that needs it, and that it doesn’t restrict the group and replicate
mappings to integer indices; the index mappers can be replaced by other
mappers, e.g. to allow interpolation between group indices, with a 1d
mesh mapper.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Finn Lindgren, Fabian E. Bachl.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
