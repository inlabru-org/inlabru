<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="inlabru">
<title>Devel: Customised model components with the bru_mapper system • inlabru</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Devel: Customised model components with the bru_mapper system">
<meta property="og:description" content="inlabru">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">inlabru</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.10.1.9006</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-general-examples">General examples</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-general-examples">
    <h6 class="dropdown-header" data-toc-skip>Basic examples</h6>
    <a class="dropdown-item" href="../articles/random_fields.html">Random field models in 1D</a>
    <a class="dropdown-item" href="../articles/random_fields_2d.html">Spatial random field models in 2D</a>
    <a class="dropdown-item" href="../articles/publications.html">Publications</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Concepts</h6>
    <a class="dropdown-item" href="../articles/component.html">Defining a model component</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Special models and techniques</h6>
    <a class="dropdown-item" href="../articles/svc.html">Spatially varying coefficient models</a>
    <a class="dropdown-item" href="../articles/zip_zap_models.html">ZIP and ZAP count models (zero-inflation)</a>
    <a class="dropdown-item" href="../articles/prediction_scores.html">Computing posterior prediction scores</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/articles.html">Full articles list</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-point-processes">Point processes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-point-processes">
    <h6 class="dropdown-header" data-toc-skip>Point process examples</h6>
    <a class="dropdown-item" href="../articles/1d_lgcp.html">LGCPs - An example in one dimension</a>
    <a class="dropdown-item" href="../articles/2d_lgcp.html">LGCPs - An example in two dimensions (sp version)</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_sf.html">LGCPs - An example in two dimensions (sf version)</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_covars.html">LGCPs - Spatial covariates</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_distancesampling.html">LGCPs - Distance sampling</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_plotsampling.html">LGCPs - Plot sampling</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_multilikelihood.html">LGCPs - Multiple likelihoods</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_spatiotemporal.html">LGCPs - An example in space and time</a>
    <a class="dropdown-item" href="../articles/2d_lgcp_residuals.html">LGCPs - Residuals</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-technical-articles">Technical articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-technical-articles">
    <h6 class="dropdown-header" data-toc-skip>Mapper techniques</h6>
    <a class="dropdown-item" href="../articles/bru_mapper.html">Customised model component with the bru_mapper system</a>
    <a class="dropdown-item" href="../articles/mesh_mapping.html">Converting inla.spde.make.A calls to the bru_mapper system</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Theory and technical documentation</h6>
    <a class="dropdown-item" href="../articles/Apptainer.html">Installation of INLA and inlabru with Apptainer on HPC</a>
    <a class="dropdown-item" href="../articles/method.html">The iterative linearised inlabru method</a>
    <a class="dropdown-item" href="../articles/linearapprox.html">A nonlinear model approximation example</a>
    <a class="dropdown-item" href="../articles/devel_flow.html">Code internal flow diagrams for model evaluation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/inlabru-org/inlabru/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Devel: Customised model components with the bru_mapper system</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/inlabru-org/inlabru/blob/HEAD/vignettes/bru_mapper.Rmd" class="external-link"><code>vignettes/bru_mapper.Rmd</code></a></small>
      <div class="d-none name"><code>bru_mapper.Rmd</code></div>
    </div>

    
    
<p>(Vignette under construction!)</p>
<div class="section level2">
<h2 id="mapper-system-introduction">Mapper system introduction<a class="anchor" aria-label="anchor" href="#mapper-system-introduction"></a>
</h2>
<p>Each inlabru latent model component generates an <em>effect</em>,
given the latent <em>state</em> vector. The purpose of the mapper system
is to define the link from state vectors to effect vectors. For an
ordinary model component, named <span class="math inline">\(c\)</span>,
this link can be represented as a matrix-vector product <span class="math display">\[
\eta_c(u_c) = A_c(\text{input}) u_c,
\]</span> where <span class="math inline">\(u_c\)</span> is the latent
state vector, <span class="math inline">\(\eta_c(u_c)\)</span> is the
resulting component effect vector, and <span class="math inline">\(A_c(\text{input})\)</span> is a <em>component
model matrix</em>. This matrix depends on the component inputs
(covariates, index information, etc) from <code>main</code>,
<code>group</code>, <code>replicate</code>, and <code>weights</code> in
the component definition.</p>
<p>The wider scope of component definitions is discussed in the <a href="https://inlabru-org.github.io/inlabru/articles/component.html">component
vignette</a>. Here, we will focus on the mapper system itself, how the
basic building blocks are used to construct the built-in mappers, and
finally how to construct new mappers.</p>
<p>The in-package documentation for the mapper methods is contained in
four parts:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">bru_mapper</span> <span class="co"># Mapper constructors</span></span>
<span><span class="op">?</span><span class="va">bru_mapper_generics</span> <span class="co"># Generic and default methods</span></span>
<span><span class="op">?</span><span class="va">bru_mapper_methods</span> <span class="co"># Specialised mapper methods</span></span>
<span><span class="op">?</span><span class="va">bru_get_mapper</span> <span class="co"># Mapper extraction methods</span></span></code></pre></div>
<p>Regular users normally at most need some of the methods from
<code><a href="../reference/bru_mapper.html">?bru_mapper</a></code> and sometimes
<code><a href="../reference/bru_mapper_generics.html">?bru_mapper_generics</a></code>. The methods in
<code>?bru_mapper_methods</code> provides more details and allows the
user to query mappers and to use them outside the context of inlabru
model definitions. The <code><a href="../reference/bru_mapper.html">bru_mapper_define()</a></code> and
<code><a href="../reference/bru_get_mapper.html">bru_get_mapper()</a></code> methods are needed for those implementing
their own mapper class.</p>
</div>
<div class="section level2">
<h2 id="mappers">Mappers<a class="anchor" aria-label="anchor" href="#mappers"></a>
</h2>
<p>The main purpose of each mapper class is to allow evaluating a
component effect, from given <code>input</code> and latent
<code>state</code>, by calling</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">input</span>, <span class="va">state</span><span class="op">)</span></span></code></pre></div>
<p>for the <code>mapper</code> associated with the component
definition.</p>
<div class="section level3">
<h3 id="basic-mappers">Basic mappers<a class="anchor" aria-label="anchor" href="#basic-mappers"></a>
</h3>
<p>Basic mappers take covariate vectors or matrices as input and numeric
vectors as state.</p>
<p>Constructors:</p>
<ul>
<li><code><a href="../reference/bru_mapper_const.html">bru_mapper_const()</a></code></li>
<li><code><a href="../reference/bru_mapper_linear.html">bru_mapper_linear()</a></code></li>
<li><code>bru_mapper_index(n)</code></li>
<li><code>bru_mapper_factor(values, factor_mapping)</code></li>
<li><code><a href="../reference/bru_mapper_matrix.html">bru_mapper_matrix()</a></code></li>
<li><code>bru_mapper_harmonics(order, scaling, intercept, interval)</code></li>
</ul>
<div class="section level4">
<h4 id="const">const<a class="anchor" aria-label="anchor" href="#const"></a>
</h4>
<p>The <code>const</code> mapper defines a mapping from an empty state
vector. This is used to define offset components, <span class="math inline">\(\eta(u)_j = z_j\)</span>, where <span class="math inline">\(z\)</span> is a fixed input vector, indexed by
<span class="math inline">\(j\)</span>.</p>
</div>
<div class="section level4">
<h4 id="linear">linear<a class="anchor" aria-label="anchor" href="#linear"></a>
</h4>
<p>The <code>linear</code> mapper defines a mapper from a length 1 state
vector. This is used to define ordinary “fixed” covariate effects,
linear in both the covariate and in the state variable; <span class="math inline">\(\eta(u)_j = z_j u\)</span>, where <span class="math inline">\(u\)</span> is the state, and <span class="math inline">\(z\)</span> is the input covariate vector.</p>
</div>
<div class="section level4">
<h4 id="index">index<a class="anchor" aria-label="anchor" href="#index"></a>
</h4>
<p>The <code>index(n)</code> mapper defines a direct mapping from a
length <code>n</code> state variable. This is used for structured and
unstructured “random effect” component effects; <span class="math inline">\(\eta(u)_j = u_{z_j}\)</span>, where <span class="math inline">\(u\)</span> is the state vector, and <span class="math inline">\(z\)</span> is the input index vector.</p>
</div>
<div class="section level4">
<h4 id="factor">factor<a class="anchor" aria-label="anchor" href="#factor"></a>
</h4>
<p>The <code>factor(values, factor_mapping)</code> mapper defines a
direct mapping between a state vector of length equal to the number of
factor levels of <code>values</code> (for
<code>factor_mapping = "full"</code>), or one less (for
<code>factor_mapping = "contrast"</code>). Each factor level is
represented as a dummy 0/1 variable, or equivalently, the input is used
as a label index into the state vector; <span class="math inline">\(\eta(u)_j = u_{z_j}\)</span>. In the
<code>"contrast"</code> case, the first factor level is removed from the
model, and the corresponding effect defined to be zero.</p>
</div>
<div class="section level4">
<h4 id="matrix">matrix<a class="anchor" aria-label="anchor" href="#matrix"></a>
</h4>
<p>The <code>matrix</code> mapper defines a direct matrix multiplication
between a pre-computed model matrix <span class="math inline">\(A_\text{input}\)</span> with the state vector;
<span class="math inline">\(\eta(u) = A_\text{input} u\)</span>. This is
used e.g. for linear model formula input, that is converted to a
component model matrix before handing it over to the mapper system.</p>
</div>
<div class="section level4">
<h4 id="harmonics">harmonics<a class="anchor" aria-label="anchor" href="#harmonics"></a>
</h4>
<p>The <code>harmonics(order, scaling, intercept, interval)</code>
mapper defines a sum of weighted harmonics on a real interval <span class="math inline">\((L, U)\)</span>, each frequency additionally
scaled by factors determined by <code>scale</code>; <span class="math inline">\(\eta(u_j) = \sum_{k=1}^{1+2p} A_{j,k}
u_k\)</span>, where <span class="math inline">\(A_{j,k}=s_k\)</span> for
<span class="math inline">\(k=1\)</span>, <span class="math inline">\(A_{j,2k}=s_{k+1}\cos[2\pi k (z_j -
L)/(U-L)]\)</span> for <span class="math inline">\(k=1,2,\dots,p\)</span>, and <span class="math inline">\(A_{j,2k+1}=s_{k+1}\sin[2\pi k (z_j -
L)/(U-L)]\)</span> for <span class="math inline">\(k=1,2,\dots,p\)</span>, where <span class="math inline">\(p=\)</span><code>order</code>. When
<code>intercept</code> is <code>TRUE</code>, the state vector has length
<span class="math inline">\(1+2p\)</span>. When <code>intercept</code>
is <code>FALSE</code>, the first, constant, column is removed, and the
state vector has length <span class="math inline">\(2p\)</span>.</p>
</div>
</div>
<div class="section level3">
<h3 id="transformation-mappers">Transformation mappers<a class="anchor" aria-label="anchor" href="#transformation-mappers"></a>
</h3>
<p>Transformation mappers are mappers that would normally be combined
with other mappers, as steps in a sequence of transformations, or as
individual transformation mappers.</p>
<ul>
<li><code><a href="../reference/bru_mapper_scale.html">bru_mapper_scale()</a></code></li>
<li><code>bru_mapper_marginal(qfun, pfun, ...)</code></li>
<li><code>bru_mapper_aggregate(rescale)</code></li>
<li><code>bru_mapper_logsumexp(rescale)</code></li>
</ul>
<div class="section level4">
<h4 id="scale">scale<a class="anchor" aria-label="anchor" href="#scale"></a>
</h4>
<p>The <code>scale</code> mapper multiplies the <code>input</code>
vector with the <code>state</code> vector. This is used for INLA models
to implement the <code>weights</code> component scaling, as the final
stage of a <code>pipe</code> mapper, see below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_scale.html">bru_mapper_scale</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="va">...</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="marginal">marginal<a class="anchor" aria-label="anchor" href="#marginal"></a>
</h4>
<p>The <code>marginal</code> mapper transforms the <code>state</code>
vector from standardised Gaussian marginal distribution to the
distribution defined by a quantile function. This can be used to define
components with latent marginal <code>N(0,1)</code> distribution but
non-Gaussian effect.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_marginal.html">bru_mapper_marginal</a></span><span class="op">(</span>qfun <span class="op">=</span> <span class="va">...</span>, pfun <span class="op">=</span> <span class="va">...</span>, dfun <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span>, inverse <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># If a list is given, it overrides the parameter specification</span></span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Examples:</span></span>
<span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_marginal.html">bru_mapper_marginal</a></span><span class="op">(</span>qfun <span class="op">=</span> <span class="va">qexp</span>, rate <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_marginal.html">bru_mapper_marginal</a></span><span class="op">(</span>qfun <span class="op">=</span> <span class="va">qexp</span>, pfun <span class="op">=</span> <span class="va">pexp</span>, dfun <span class="op">=</span> <span class="va">dexp</span>, rate <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="aggregate">aggregate<a class="anchor" aria-label="anchor" href="#aggregate"></a>
</h4>
<p>The <code>aggregate</code> mapper aggregates the <code>state</code>
vector elements by blockwise summation after scaling the elements by
weights. This can be used for summation, integration, and averaging (for
<code>rescale=TRUE</code>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_aggregate.html">bru_mapper_aggregate</a></span><span class="op">(</span>rescale <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>block <span class="op">=</span> <span class="va">...</span>, weights <span class="op">=</span> <span class="va">...</span><span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="logsumexp">logsumexp<a class="anchor" aria-label="anchor" href="#logsumexp"></a>
</h4>
<p>The <code>logsumexp</code> mapper aggregates the
<code>exp(state)</code> vector elements by blockwise summation after
scaling the elements by weights, and takes the logarithm. The
implementation takes care to avoid numerical overflow. This can be used
for summation, integration, and averaging (for
<code>rescale=TRUE</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_logsumexp.html">bru_mapper_logsumexp</a></span><span class="op">(</span>rescale <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>block <span class="op">=</span> <span class="va">...</span>, weights <span class="op">=</span> <span class="va">...</span><span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="compound-mappers">Compound mappers<a class="anchor" aria-label="anchor" href="#compound-mappers"></a>
</h3>
<p>Compound mappers define collections or chains of mappings, and can
take various forms of input. The state vector is normally a numeric
vector, but can in some cases be a list of vectors.</p>
<ul>
<li><code>bru_mapper_collect(mappers, hidden)</code></li>
<li><code>bru_mapper_multi(mappers)</code></li>
<li><code>bru_mapper_pipe(mappers)</code></li>
</ul>
<div class="section level4">
<h4 id="collect">collect<a class="anchor" aria-label="anchor" href="#collect"></a>
</h4>
<p>The <code>collect</code> mapper defines a compound mapper where the
Jacobian is block-diagonal, and each block is defined by a separate
sub-mapper. When <code>hidden = TRUE</code>, it can be used for INLA
models where the user-visible part of the latent state is only a part of
the internal state, such as for <code>"bym"</code> models.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_collect.html">bru_mapper_collect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name1 <span class="op">=</span> <span class="va">...</span>, name2 <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>  hidden <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name1 <span class="op">=</span> <span class="va">...</span>, name2 <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># If hidden = TRUE, the inla_f=TRUE argument "hides" all but the first mapper:</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="va">name1_input</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span>,</span>
<span>  inla_f <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="multi">multi<a class="anchor" aria-label="anchor" href="#multi"></a>
</h4>
<p>The <code>multi</code> mapper defines a compound mapper where the
Jacobian is the row-wise Kronecker product between the sub-mapper
Jacobians. This can be used for INLA models to construct the internal
mapper for <code>main</code>, <code>group</code>, and
<code>replicate</code>, but also for user-defined models where a single
<code>rgeneric</code> or <code>cgeneric</code> model is defined on e.g.
a space-time product domain.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_multi.html">bru_mapper_multi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name1 <span class="op">=</span> <span class="va">...</span>, name2 <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name1 <span class="op">=</span> <span class="va">...</span>, name2 <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="pipe">pipe<a class="anchor" aria-label="anchor" href="#pipe"></a>
</h4>
<p>Pipe mappers chain multiple mappers into a sequence, where the
evaluation result of each mapper is given as the state vector for the
next mapper.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_pipe.html">bru_mapper_pipe</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name1 <span class="op">=</span> <span class="va">...</span>, name2 <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name1 <span class="op">=</span> <span class="va">...</span>, name2 <span class="op">=</span> <span class="va">...</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="the-core-model-component-mapper">The core model component mapper<a class="anchor" aria-label="anchor" href="#the-core-model-component-mapper"></a>
</h4>
<p>All model component mappers are currently defined as a
<code>pipe</code> mapper containing a <code>multi</code> mapper followed
by a <code>scale</code> mapper:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/bru_mapper_pipe.html">bru_mapper_pipe</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      mapper <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper_multi.html">bru_mapper_multi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">...</span>, group <span class="op">=</span> <span class="va">...</span>, replicate <span class="op">=</span> <span class="va">...</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      scale <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper_scale.html">bru_mapper_scale</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>,</span>
<span>  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mapper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">...</span>, group <span class="op">=</span> <span class="va">...</span>, replicate <span class="op">=</span> <span class="va">...</span><span class="op">)</span>,</span>
<span>    scale <span class="op">=</span> <span class="va">...</span></span>
<span>  <span class="op">)</span>,</span>
<span>  state <span class="op">=</span> <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="object-mappers">Object mappers<a class="anchor" aria-label="anchor" href="#object-mappers"></a>
</h3>
<p>For object with predefined mapper conversion methods, use
<code>bru_mapper(object)</code> to obtain a suitable mapper object.
Current predefined object mappers are defined for objects of these
classes:</p>
<ul>
<li>
<code>fm_mesh_2d</code> and <code>inla.mesh</code>; Use
<code>bru_mapper(object)</code>
</li>
<li>
<code>fm_mesh_1d</code> and <code>inla.mesh.1d</code>; Use
<code>bru_mapper(object, indexed)</code>
</li>
</ul>
<p>More details are given below.</p>
</div>
<div class="section level3">
<h3 id="model-object-mappers">Model object mappers<a class="anchor" aria-label="anchor" href="#model-object-mappers"></a>
</h3>
<p>For inla model objects with predefined mappers, use
<code>bru_get_mapper(object)</code> Current predefined model object
mappers are defined for models of these classes:</p>
<ul>
<li>
<code>inla.spde</code>; this includes
<code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.matern.html" class="external-link">inla.spde2.matern()</a></code> and <code><a href="https://rdrr.io/pkg/INLA/man/inla.spde2.pcmatern.html" class="external-link">inla.spde2.pcmatern()</a></code>
models. The conversion method calls <code><a href="../reference/bru_mapper.html">bru_mapper()</a></code> in the
appropriate way for the mesh type used for the model</li>
<li>
<code>inla.rgeneric</code>; This relies on the rgeneric definition
including a <code>"mapper"</code> callback argument. A less invasive
method, that works for both rgeneric and cgeneric models, is to define a
<code><a href="../reference/bru_get_mapper.html">bru_get_mapper()</a></code> method for the class, which needs to
include a unique class identifier, e.g. add
<code>class(object) &lt;- c("my_unique_model_class", class(object))</code>
and define</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bru_get_mapper.my_unique_model_class</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>and register it in the namespace.</p>
</div>
<div class="section level3">
<h3 id="special-mappers">Special mappers<a class="anchor" aria-label="anchor" href="#special-mappers"></a>
</h3>
<ul>
<li><code><a href="../reference/bru_mapper_taylor.html">bru_mapper_taylor()</a></code></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="mapper-methods">Mapper methods<a class="anchor" aria-label="anchor" href="#mapper-methods"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">inla_f</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n_output</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">input</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">inla_f</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_jacobian</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">input</span>, <span class="va">state</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_eval</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">input</span>, <span class="va">state</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_names</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_inla_subset</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>An example where the <code>inla_f</code> argument matters is the
<code>bru_mapper_collect</code> class, when the <code>hidden=TRUE</code>
argument is used to indicate that only the first mapper should be used
for the <code><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">INLA::f()</a></code> inputs, e.g. for <code>"bym2"</code>
models. For <code>inla_f=FALSE</code> (the default), the
<code>ibm_n</code> and <code>ibm_values</code> methods return the total
number of latent variables, but with <code>inla_f=TRUE</code> we get the
values needed by <code><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">INLA::f()</a></code> instead:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_collect.html">bru_mapper_collect</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    a <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper_index.html">bru_mapper_index</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>    b <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper_index.html">bru_mapper_index</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  hidden <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span>, multi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span>, multi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span></code></pre></div>
<p>For the <code>bru_mapper_multi</code> class, the <code>multi</code>
argument provides access to the inner layers of the multi-mapper:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_multi.html">bru_mapper_multi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  a <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper_index.html">bru_mapper_index</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fu"><a href="../reference/bru_mapper_index.html">bru_mapper_index</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;   a b</span></span>
<span><span class="co">#&gt; 1 1 1</span></span>
<span><span class="co">#&gt; 2 2 1</span></span>
<span><span class="co">#&gt; 3 3 1</span></span>
<span><span class="co">#&gt; 4 1 2</span></span>
<span><span class="co">#&gt; 5 2 2</span></span>
<span><span class="co">#&gt; 6 3 2</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5 6</span></span>
<span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span>, multi <span class="op">=</span> <span class="cn">TRUE</span>, inla_f <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;   a b</span></span>
<span><span class="co">#&gt; 1 1 1</span></span>
<span><span class="co">#&gt; 2 2 1</span></span>
<span><span class="co">#&gt; 3 3 1</span></span>
<span><span class="co">#&gt; 4 1 2</span></span>
<span><span class="co">#&gt; 5 2 2</span></span>
<span><span class="co">#&gt; 6 3 2</span></span></code></pre></div>
<p>The default <code>ibm_inla_subset</code> method determines the inla
subset by comparing the full values information from
<code>ibm_values(mapper, inla_f = FALSE)</code> to the inla specific
values information from <code>ibm_values(mapper, inla_f = TRUE)</code>,
to determine the logical vector identifying the inla values subset.
Custom mappers should normally not need to specialise this method.</p>
</div>
<div class="section level2">
<h2 id="mappers-for-inla-mesh-objects">Mappers for inla.mesh objects<a class="anchor" aria-label="anchor" href="#mappers-for-inla-mesh-objects"></a>
</h2>
<p>For component models referenced by a character label
(e.g. <code>"iid"</code>, <code>"bym2"</code>, <code>"rw2"</code> etc),
inlabru will construct default mappers, that in most cases replicate the
default <code><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">INLA::f()</a></code> behaviour.</p>
<p>For the <code>fm_mesh_1d</code>, <code>fm_mesh_2d</code>,
<code>inla.mesh</code> and <code>inla.mesh.1d</code> classes, default
mappers can be constructed by the pre-defined <code>bru_mapper</code> S3
methods. For 2d meshes (<code>fm_mesh_2d</code>,
<code>inla.mesh</code>),</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p>For 1d meshes (<code>fm_mesh_1d</code>,
<code>inla.mesh.1d</code>),</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If ibm_values() should return mesh$loc (e.g. for "rw2" models</span></span>
<span><span class="co"># with degree=1 meshes)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span>, indexed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># If ibm_values() should return seq_along(mesh$loc) (e.g. for</span></span>
<span><span class="co"># inla.spde2.pcmatern() models)</span></span>
<span><span class="fu"><a href="../reference/bru_mapper.html">bru_mapper</a></span><span class="op">(</span><span class="va">mesh</span>, indexed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="customised-mappers">Customised mappers<a class="anchor" aria-label="anchor" href="#customised-mappers"></a>
</h2>
<p>A mapper object should store enough information in order for the
<code>ibm_*</code> methods to work. The simplest case of a customised
mapper is to just attached a new class label to the front of the S3
<code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> information of an existing mapper, to obtain a
class to override some of the standard <code>ibm_*</code> method
implementations. More commonly, one would instead start with a basic
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>, that might <em>contain</em> an existing mapper
object, and then add methods that know how to use that information. In
all these cases, the <code><a href="../reference/bru_mapper.html">bru_mapper_define()</a></code> method should be
used to properly set the class information:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_define</a></span><span class="op">(</span><span class="va">mapper</span>, <span class="va">new_class</span><span class="op">)</span></span></code></pre></div>
<p>Implementations can avoid having to define <code>ibm_n</code> and
<code>ibm_values</code> methods, by instead computing and storing
<code>n</code>, <code>n_inla</code>, <code>values</code>, and
<code>values_inla</code> in the mapper object during construction:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_define</a></span><span class="op">(</span></span>
<span>  mapper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span>, values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  new_class <span class="op">=</span> <span class="st">"my_bru_mapper_class_name"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The default <code>ibm_n</code> and <code>ibm_values</code> methods
checks if these values are available, and return the appropriate values
depending on the <code>inla_f</code> argument. When <code>*_inla</code>
values are requested but not available, the methods fall back to the
non-inla versions. If the needed information is not found, the default
methods give an error message.</p>
<p>Note: Before version 2.6.0, <code>ibm_amatrix</code> was used instead
of <code>ibm_jacobian</code>. Version 2.6.0 still supports this, by
having the default <code>ibm_jacobian</code> method call
<code>ibm_amatrix</code>, but will give a deprecation message later, and
it may be removed in a future version.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>Let’s build a mapper class <code>bru_mapper_p_quadratic</code> for a
model component that takes input covariates with values <span class="math inline">\(a_{ij}\)</span>, <span class="math inline">\(i=1,\dots,m\)</span> and <span class="math inline">\(j=1,\dots,p\)</span>, in a <code>matrix</code> or
<code>data.frame</code> and evaluates a full quadratic expression <span class="math display">\[
\eta_i = x_0 + \sum_{j=1}^p a_{ij} x_j +
  \frac{1}{2}\sum_{j=1}^p\sum_{k=1}^j \gamma_{j,k} a_{ij}a_{ik} x_{j,k},
\]</span> where the latent component vector is <span class="math inline">\(\boldsymbol{x}=[x_0,x_1,\dots,x_p,x_{1,1},\dots,x_{p,1},x_{2,2}\dots,x_{p,p}]\)</span>,
and <span class="math display">\[
\gamma_{j,k} = \begin{cases}
1, &amp; j = k,\\
2, &amp; j &gt; k.
\end{cases}
\]</span></p>
<p>We start with the constructor method. Like the
<code>bru_mapper_matrix</code>, we require the user to supply a vector
of covariate labels, and store them as a character vector. We also
include a <code>min_degree</code> parameter to control if an intercept
(<code>min_degree &lt;= 0</code>) and linear terms
(<code>min_degree &lt;= 1</code>) should be included in the model.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bru_mapper_p_quadratic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">labels</span>, <span class="va">min_degree</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/is.bool.html" class="external-link">is.factor</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/factors.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span>,</span>
<span>      min_degree <span class="op">=</span> <span class="va">min_degree</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span>,</span>
<span>      min_degree <span class="op">=</span> <span class="va">min_degree</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_define</a></span><span class="op">(</span><span class="va">mapper</span>, new_class <span class="op">=</span> <span class="st">"bru_mapper_p_quadratic"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>ibm_n</code> method can compute the value of <span class="math inline">\(n\)</span> from <span class="math inline">\(n=1+p+\frac{p(p+1)}{2}\)</span>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ibm_n.bru_mapper_p_quadratic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapper</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">labels</span><span class="op">)</span></span>
<span>  <span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">min_degree</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">min_degree</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">p</span> <span class="op">+</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For <code>ibm_values</code>, the default method is sufficient,
returning the vector <span class="math inline">\([1,\dots,n]\)</span>
with <span class="math inline">\(n\)</span> obtained by
<code>ibm_n(mapper)</code>. However, for clearer result naming, we can
use a character vector, at least for INLA <code><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f()</a></code> models that
allow it (we could have an option argument to the
<code>bru_mapper_p_quadratic</code> constructor to control this):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ibm_values.bru_mapper_p_quadratic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapper</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">labels</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span>  <span class="va">jk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">jk</span> <span class="op">&lt;-</span> <span class="va">jk</span><span class="op">[</span><span class="va">jk</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="va">jk</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">min_degree</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="st">"Intercept"</span> <span class="kw">else</span> <span class="cn">NULL</span>,</span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">min_degree</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">mapper</span><span class="op">$</span><span class="va">labels</span> <span class="kw">else</span> <span class="cn">NULL</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">labels</span><span class="op">[</span><span class="va">jk</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">":"</span>, <span class="va">mapper</span><span class="op">$</span><span class="va">labels</span><span class="op">[</span><span class="va">jk</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>While the approach to <code>ibm_n</code> and <code>ibm_values</code>
above works, it is wasteful to recompute the <code>n</code> and
<code>values</code> information for each call. Instead we can use that
the default method will check if <code>n</code> or <code>values</code>
are stored in the mapper object, and then return them. If we change the
<code>.</code> in the method definitions to <code>_</code>, we can end
the constructor method like this, making subsequent method calls
faster:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bru_mapper_p_quadratic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">labels</span>, <span class="va">min_degree</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">mapper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper.html">bru_mapper_define</a></span><span class="op">(</span><span class="va">mapper</span>, new_class <span class="op">=</span> <span class="st">"bru_mapper_p_quadratic"</span><span class="op">)</span></span>
<span>  <span class="va">mapper</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu">ibm_n_bru_mapper_p_quadratic</span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span>  <span class="va">mapper</span><span class="op">$</span><span class="va">values</span> <span class="op">&lt;-</span> <span class="fu">ibm_values_bru_mapper_p_quadratic</span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span>  <span class="va">mapper</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that the order matters, since our
<code>ibm_values_bru_mapper_p_quadratic</code> function calls
<code>ibm_n(mapper)</code>.</p>
<p>We can now define the main part of the mapper interface that computes
the model matrix linking the latent variables to the component effect.
It’s required that <code>NULL</code> input should return a <span class="math inline">\(0\)</span>-by-<span class="math inline">\(n\)</span> matrix.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ibm_jacobian.bru_mapper_p_quadratic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mapper</span>, <span class="va">input</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">labels</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_n</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span>  <span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">in_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">input</span>, <span class="st">"Matrix"</span><span class="op">)</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">min_degree</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">A</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">mapper</span><span class="op">$</span><span class="va">min_degree</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">A</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">in_</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">idx</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">A</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">in_</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">p</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op">*</span> <span class="va">in_</span><span class="op">[</span>, <span class="va">k</span><span class="op">]</span></span>
<span>    <span class="va">A</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">A</span><span class="op">[[</span><span class="va">idx</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="va">k</span><span class="op">]</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">A</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="../reference/bru_mapper_generics.html">ibm_values</a></span><span class="op">(</span><span class="va">mapper</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">A</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If the output of a mapper is of a different size than
<code>NROW(input)</code>, the mapper should define a
<code>ibm_n_output(mapper, input, ...)</code> method to return the
output size for a given input.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Finn Lindgren, Fabian E. Bachl.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
